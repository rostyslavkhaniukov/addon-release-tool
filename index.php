<?php
declare(strict_types=1);

require_once __DIR__ . '/vendor/autoload.php';

use AirSlate\Releaser\Builder;
use AirSlate\Releaser\Client;
use AirSlate\Releaser\FileProcessor;

$client = new Client([
    'owner' => 'airslateinc',
    'token' => '',
]);

$addons = [
    'prefill-from-source-addons',
    'audit-trail-addon',
    'change-order-addon',
    'document-prefill-addon',
    'dropdown-options-prefill-addon',
    'google-calendar-addon',
    'google-spreadsheets-duplex-addon',
    'google-spreadsheets-postfinish-addon',
    'google-spreadsheets-watcher-addon',
    'jira-addon',
    'lock-slate-bot',
    'notification-addon',
    'export-to-source-addons',
    'packet-delete-addon',
    'recipient-to-role-addon',
    'revoke-access-addon',
    'roles-users-management-addon',
    'send-slate-addon',
    'set-packet-name-addon',
    'slack-notifier-addon',
    'slate-prefill-addon',
    'smartsheet-export-addon',
    'sms-notifier-addon',
    'tags-addon',
    'webhook-addon',
    'weekly-reminder-addon',
];

/*foreach ($addons as $addon) {
    (new Builder($client, 'airslateinc', $addon))
        ->from('master')
        ->branch('ADD-3522-update-php-image')
        ->step(function (FileProcessor $file) {
            return $file
                ->take('Dockerfile')
                ->replace(
                    '/(pdffiller\/php7[12]-ubuntu16:v)\d+\.\d+\.\d+/',
                    '${1}1.2.0'
                );
        })
        ->commit('[ADD-3522] Update base docker image')
        ->push()
        ->makePR('[ADD-3522] Update base docker image', 'Autogenerated PR');
}*/

foreach ($addons as $addon) {
    $pulls = $client->pullRequests()->all($addon);
    foreach ($pulls as $pull) {
        if (mb_strpos($pull->getTitle(), 'ADD-3522') !== false) {
            echo $pull->htmlUrl . ' - ';
            $approves = 0;
            $approver = [];
            $reviews = $client->pullRequests()->reviews($addon, $pull->getNumber());
            foreach ($reviews as $review) {
                if ($review->state === 'APPROVED') {
                    $approves++;
                    $approver[] = $review->getUser()->login;
                }
            }
            echo $approves . " (" . implode(", ", $approver) .  ")\n";
        }
    }
}
